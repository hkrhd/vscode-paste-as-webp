# 画像→WebP変換ライブラリ検討

## 現状
`src/image-processor.ts`でsharpを使用してPNG/JPG→WebP変換を実施。

```ts
return await sharp(buffer).webp({ quality }).toBuffer();
```

## Canvas APIについて
**VS Code拡張では直接使用不可**

- VS Code拡張はNode.js環境で動作
- ブラウザのCanvas APIはNode.jsに存在しない
- WebView経由で使う方法は非効率でUX悪化

## 代替ライブラリ比較

| ライブラリ | Native依存 | 課題 |
|-----------|-----------|------|
| **sharp** | Yes | 現行採用。高速で安定 |
| **webp-wasm** | No (WASM) | PNG→RGBAデコードに別ライブラリ必要 |
| **@jsquash/*** | No (WASM) | Node.jsは実験的。公式がsharp推奨 |
| **node-canvas** | Yes (Cairo) | sharpと同じネイティブ問題 |
| **webp-converter** | No | 外部バイナリ(cwebp)同梱。5年未更新 |

## 各ライブラリ詳細

### webp-wasm
- GitHub: https://github.com/jhuckaby/webp-wasm
- Squooshから派生したWASMベースのWebPエンコーダ/デコーダ
- **入力形式**: RGBA ImageData (`{ data: Uint8ClampedArray, width, height }`)
- **問題**: PNG/JPGバッファを直接受け付けない。`pngjs`等で事前デコード必要

```
PNG Buffer → pngjsでRGBAデコード → webp-wasmでWebPエンコード
```

### @jsquash/*
- GitHub: https://github.com/jamsinclair/jSquash
- ブラウザ/WebWorker向けに最適化
- **Node.jsサポート**: 実験的・限定的
- **公式見解**: "For much better Node-based alternatives please check out Sharp"
- WASMファイルの手動設定が必要

### node-canvas
- Canvas APIのNode.js実装
- **依存**: Cairo (ネイティブライブラリ)
- sharpと同様のクロスプラットフォームビルド問題が発生

## 結論
sharpがNode.js環境でのWebP変換における最適解。

WASMベースの代替は存在するが：
1. 追加の依存(PNGデコーダ等)が必要
2. Node.jsサポートが限定的/実験的
3. パフォーマンスが劣る
4. 公式がsharpを推奨している

ネイティブビルド問題を回避したい場合は`webp-wasm` + `pngjs`の組み合わせが現実的だが、複雑さとパフォーマンスのトレードオフを考慮する必要あり。